name: CI
on:
    push:
        branches:
            - "main"
        tags:
            - "v[0-9]+.[0-9]+.[0-9]+"
    pull_request:
        branches: [ main ]
jobs:
    pre-commit:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2
            -   uses: actions/setup-python@v2
                with:
                    python-version: "3.7"
            -   uses: pre-commit/action@v2.0.3
    test-unit:
        name: Run unit tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version:
                    - "3.7"
        steps:
            -   uses: actions/checkout@v2
            -   name: Setup python
                uses: actions/setup-python@v2
                with:
                    python-version: ${{ matrix.python-version }}
            -   name: Install Poetry
                run: curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python3 -
            -   name: Install Code
                run: |
                    source "$HOME/.poetry/env"
                    poetry install
            -   name: Run pytest
                run: |
                    source "$HOME/.poetry/env"
                    poetry run pytest
    compliance-copyrights:
        name: Compliance Copyright Headers
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v2
            -   name: Check License Header
                uses: apache/skywalking-eyes@main
    compliance-dependencies:
        name: Compliance Dependencies
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v2
            -   name: ort-action
                uses: splunk/addonfactory-ort-action@v1
                id: ort-action
                with:
                    WorkDir: .
                    UsePython3: "3.7"
            -   name: ort-action-artifacts-reports
                uses: actions/upload-artifact@v2
                with:
                    name: analysis-reports
                    path: |
                        .ort/reports/*
                if: always()
            -   name: ort-action-artifacts-analyzer
                uses: actions/upload-artifact@v2
                with:
                    name: analysis-analyzer
                    path: |
                        .ort/analyzer/*
                if: always()
